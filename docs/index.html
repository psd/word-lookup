<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
    font-weight: 600;
    margin: 0 1em;
}

#search {
    font-family: monospace;
    font-size: 32px;
    font-weight: 600;
    display: block;
    margin: 0;
    padding: 10px;
    height: 40px;
    line-height: 40px;
    border: 4px solid #888;
    border-radius: 5px;
    font-family: monospace;
    font-size: 32px;
}

ul {
    list-style-type: none;
    padding: 0;
}

aside {
    width: 100%;
}

#helpbox {
    margin: 1em 0;
}

#help {
    accent-color: #000;
}

#help + .message {
    display: none;
    opacity: 0;
    transition: visibility 0s linear 0.33s, opacity 0.33s linear;
}
    
#help:checked + .message {
    display: block;
    opacity: 1;
    transition-delay: 0s;
}

.score {
    font-family: monospace;
    color: #888;
}

</style>
</head>
<body>
    <input type="text" id="search" size="10" value="^......$">
    <div id="results"></div>
    <aside id=helpbox>
        <label for="help">
	    <input type="checkbox" name="help" id=help />
	    help
            <div class="message">
		<p>Find dictionary words"
	        <dl>
	        <dt>cd</dt>
		<dd>containing "cd"</dd>
	        <dt>ey$ =5</dt>
		<dd>ending in "ey" which are 5 letters long</dd>
	        <dt>^ex &lt;6</dt>
		<dd>beginning with "ex"</dd>
	        <dt>ey$ &lt;6</dt>
		<dd>ending in "ey" which are 6 or fewer letters long</dd>
	        <dt>ey$ &lt;6 &gt;4</dt>
		<dd>ending in "ey" which are 4, 5 or 6 letters long</dd>
	        <dt>ey$ +kd</dt>
		<dd>ending in "ey", containing k and d</dd>
	        <dt>ey$ -of</dt>
		<dd>ending in "ey", not containing o or f</dd>
		<dt>^l#x$ f#x$</dt>
		<dd>which intersect</dd>
	        </dl>
	    </div>
	</label>
    </aside>
<script defer>
if (!Set.prototype.union) {
    Set.prototype.union = function(a) {
        return new Set([...this, ...a]);
    }
}

if (!Set.prototype.intersection) {
    Set.prototype.intersection = function(a) {
        return new Set([...this].filter(x => a.has(x)));
    }
}

if (!Set.prototype.equal) {
    Set.prototype.equal = function(a) {
	return this.size === a.size && [...this].every(value => a.has(value));
    }
}

score_letters = {
    1: "aeioulnstr",
    2: "dg",
    3: "bcmp",
    4: "fhvwy",
    5: "k",
    8: "jx",
    10: "qz"
}
letter_score = {}
for (const [score, letters] of Object.entries(score_letters)) {
    for (var i = 0; i < letters.length; i++) {
	letter_score[letters[i]] = score
    }
}

function score_word(word) {
    var score = 0
    for (var i = 0; i < word.length; i++) {
	score = score + parseInt(letter_score[word[i]])
    }
    return score
}


fetch("words")
   .then(response => response.text())
   .then((response) => {
   	words = response.split(/\n/)

	function lookup() {
	    // parse search string
	    let search = document.getElementById("search").value.toLowerCase();

	    class Pattern {
	        constructor() {
		    this.includes = new Set()
		    this.excludes = new Set()
	            this.len = 0
		    this.min = 0
		    this.max = 0
		    this.regex = ""
		}
	    }

	    let patterns = [new Pattern()]
	    let n = 0

	    search.split(" ").forEach((leg)=>{
	    	if (leg) {
		    if (leg.startsWith("+")) {
			patterns[n].includes = patterns[n].includes.union(new Set(leg.slice(1)));
		    } else if (leg.startsWith("-")) {
			patterns[n].excludes = patterns[n].excludes.union(new Set(leg.slice(1)));
		    } else if (leg.startsWith("=")) {
		        patterns[n].len = Number(leg.slice(1))
		    } else if (leg.startsWith(">")) {
		    	patterns[n].min = Number(leg.slice(1))
		    } else if (leg.startsWith("<")) {
		    	patterns[n].max = Number(leg.slice(1))
		    } else {
			if (patterns[n].regex !== "") {
			    patterns.push(new Pattern())
			}
			n = patterns.length - 1
		        patterns[n].regex = leg
		    }
		}
	    })

	    // search for words
	    let div = document.getElementById("results");
	    div.innerHTML = ""
	    intersect = false
	    intersect_set = new Set()

	    patterns.forEach((pattern)=>{
		let list = document.createElement("ul");
		div.appendChild(list);

		if (pattern.regex.includes("#")) {
		    if (!intersect) {
			pattern.regex = pattern.regex.replace("#", "(.)")
			intersect = true
		    } else {
			s = Array.from(intersect_set).join('')
			pattern.regex = pattern.regex.replace("#", "([" + s + "])")
		    }
		}

		words.forEach((word)=>{
		    let letters = new Set(word)

		    if (pattern.len && word.length != pattern.len) {
			return
		    }

		    if (pattern.min && word.length < pattern.min) {
			return
		    }

		    if (pattern.max && word.length > pattern.max) {
			return
		    }

		    if (pattern.includes.size && !letters.intersection(pattern.includes).equal(pattern.includes)) {
			return
		    }

		    if (pattern.excludes.size && pattern.excludes.intersection(letters).size) {
			return
		    }

		    matches = word.match(pattern.regex)
		    if (!matches) {
			return
		    }

		    if (intersect) {
			intesect_set = intersect_set.add(matches[1])
		    }

		    let li = document.createElement("li");
		    let span = document.createElement("span");
		    let score = score_word(word)

		    li.innerText = word + " "
		    li.appendChild(span)
		    span.innerText = score
		    span.className = "score"
		    div.appendChild(li);
		})
	    })
        }
	window.addEventListener('keyup', function(event) {
	    if (event.keyCode === 13) {
		lookup()
	    }
	});
   })
   .catch(err => console.log(err))

</script>
</body>
</html>
